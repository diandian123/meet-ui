const wxfs=wx.getFileSystemManager();Component({options:{addGlobalClass:!0},properties:{type:{type:String,value:"normal"},items:{type:Array,value:[]},column:{type:Number,value:3},maxCount:{type:Number,value:9},imageMode:{type:String,value:"aspectFill"},sizeType:{type:Array,value:["original"]},sourceType:{type:Array,value:["album","camera"]},preview:{type:Boolean,value:!0},disabled:{type:Boolean,value:!1},maxSize:{type:Number,value:-1},sortable:{type:Boolean,value:!1}},observers:{items(t){t&&this.init()}},data:{ready:!1,itemList:[],imageList:[],draging:!1,touchMove:"",startIndex:null,canvasWidth:0,canvasHeight:0},methods:{init(){var{type:t,maxCount:e}=this.data,i=this.data.items.slice(0,this.data.maxCount),a=[...i];const s=[...i];this.changeFlag=!1,"normal"===t&&s.length<e&&s.push({type:"upload"}),this.setData({ready:!1,imageList:a,itemList:s},()=>{this.initPosition()})},initPosition(){this.queryContainerPosition(),this.queryNodePosition()},queryContainerPosition(){const t=wx.createSelectorQuery().in(this);t.select("#dragBox").boundingClientRect(t=>{this.container={top:t.top,left:t.left,height:t.height}}).exec()},queryNodePosition(){const t=wx.createSelectorQuery().in(this);t.selectAll(".mt-imagepicker__item").boundingClientRect(n=>{this.setData({ready:!0,itemList:this.data.itemList.map((t,e)=>{var i=n[e].top-this.container.top,a=n[e].left-this.container.left;let s={index:e,boxWidth:n[e].width,boxHeight:n[e].height,boxTop:i,boxLeft:a,top:i,left:a};return"upload"===t.type?s.type="upload":(s.type="image",s={...t,...s}),s})})}).exec()},handleLongPress(t){if(1<t.touches.length)return this.setData({draging:!1,touchMove:"",startIndex:null}),!1;this.queryContainerPosition();var e=t.changedTouches[0],t=t.currentTarget.dataset["index"];this.setData({draging:!0,touchMove:"handleTouchMove",startIndex:t}),this.startClient={startX:e.clientX,startY:e.clientY,startTop:this.data.itemList[t].top,startLeft:this.data.itemList[t].left},wx.vibrateShort()},handleTouchMove(t){if(this.data.draging){if(1<t.touches.length)return this.handleTouchend(),!1;var a=t.changedTouches[0];const h=this.data.itemList;var s=this.data.startIndex,t=a.clientX-this.startClient.startX,n=a.clientY-this.startClient.startY;h[s].top=this.startClient.startTop+n,h[s].left=this.startClient.startLeft+t,this.setData({itemList:h});let e=null,i=null;var o=this.container.left,r=this.container.top;for(let t=0;t<h.length;t++)s!==t&&"upload"!==h[t].type&&a.clientX>o+h[t].left&&a.clientY>r+h[t].top&&a.clientX<o+h[t].left+h[t].boxWidth&&a.clientY<r+h[t].top+h[t].boxHeight&&(i=t,e=h[s].boxTop>h[t].top?"up":h[s].boxTop<h[t].top?"down":h[s].boxLeft>h[t].left?"left":"right");e&&this.swapPosition(e,i)}},swapPosition(t,e){this.changeFlag=!0;const i=this.data.itemList;if("left"===t||"up"===t){var a=i[e].index,s=i[this.data.startIndex].index;const h=[...i];for(let e=a;e<s;e++){var n=h.find(t=>t.index===e+1),o=h.findIndex(t=>t.index===e);i[o]={...i[o],index:n.index,top:n.boxTop,left:n.boxLeft,boxTop:n.boxTop,boxLeft:n.boxLeft}}a=h[e];i[this.data.startIndex]={...i[this.data.startIndex],index:a.index,boxTop:a.boxTop,boxLeft:a.boxLeft}}else{var r;"right"!==t&&"down"!==t||(a=i[this.data.startIndex].index,t=i[e].index,r=[...i],this._swapPrev(t,a),t=r[e],i[this.data.startIndex]={...i[this.data.startIndex],index:t.index,boxTop:t.boxTop,boxLeft:t.boxLeft})}this.setData({itemList:i})},_swapPrev(t,i){const a=this.data.itemList,s=[...a];for(let e=t;e>i;e--){var n=s.find(t=>t.index===e-1),o=s.findIndex(t=>t.index===e);a[o]={...a[o],index:n.index,top:n.boxTop,left:n.boxLeft,boxTop:n.boxTop,boxLeft:n.boxLeft}}},handleTouchend(){if(this.data.draging){const e=this.data.itemList;var t=e[this.data.startIndex];if(e[this.data.startIndex]={...t,top:t.boxTop,left:t.boxLeft},this.setData({itemList:e}),this.changeFlag){const i=this.data.itemList.filter(t=>"upload"!==t.type),a=(i.sort((t,e)=>t.index-e.index),this.formatImageList(i));setTimeout(()=>{this.setData({draging:!1,touchMove:"",startIndex:null,items:i}),this.triggerEvent("change",{imageList:a})},200)}else this.setData({draging:!1,touchMove:"",startIndex:null})}},handleDelete(t){var e=this.data.itemList,t=t.currentTarget.dataset.index,i=e.length-1;this._swapPrev(i,t),this.data.itemList.splice(t,1),this.setData({draging:!0,itemList:e});const a=this.data.itemList.filter(t=>"upload"!==t.type),s=this.formatImageList(a);setTimeout(()=>{this.setData({draging:!1,touchMove:"",startIndex:null,items:a}),this.triggerEvent("change",{imageList:s})},200)},formatImageList(t){return t.map(t=>({src:t.src,width:t.width,height:t.height,uploaded:t.uploaded??!0,mimeType:t.mimeType||"",size:t.size||-1}))},readFile(t){return new Promise((e,i)=>{wxfs.readFile({filePath:t,success(t){e(t.data)},fail(t){i(t)}})})},handleChoose(){if(!this.data.disabled){var t=this.data.maxCount-this.data.items.length;const h=this.data.maxSize;wx.chooseMedia({count:t,sourceType:this.data.sourceType,sizeType:this.data.sizeType,mediaType:["image"],success:async t=>{let e=t.tempFiles;-1!==h&&(e=e.filter(t=>{return parseInt(t.size/1024)<=h}),0<(t=t.tempFiles.length-e.length)&&wx.showToast({icon:"none",duration:3e3,title:t+"张图片超出大小限制"}));try{const o=[];for(const r of e){var i=await this.getImageInfo(r);o.push(i)}var a=o.map(t=>({src:t.src,width:t.width,height:t.height,mimeType:"image/"+t.type,uploaded:!1})),s=(this.data.itemList.splice(this.data.itemList.length-1,1),this.formatImageList([...this.data.imageList,...a])),n=[...this.data.itemList,...a];this.setData({items:n}),this.triggerEvent("change",{imageList:s})}catch(t){}}})}},getImageInfo(t){return new Promise((e,i)=>{wx.getImageInfo({src:t.tempFilePath,success:async t=>{"gif"===t.type||"up"===t.orientation?e({orientation:t.orientation,type:t.type,src:t.path,width:t.width,height:t.height}):(t=await this.convertImage({orientation:t.orientation,type:t.type,src:t.path,width:t.width,height:t.height}),e({orientation:t.orientation,type:t.type,src:t.src,width:t.width,height:t.height}))},fail(t){i(t)}})})},convertImage(n){return new Promise(i=>{const t=wx.createCanvasContext("compressCanvas",this);let a=n.width,s=n.height;switch(n.orientation){case"up":case"down":1280<a&&(e=s/a,a=1280,s=Math.floor(1280*e)),this.setData({canvasWidth:a,canvasHeight:s}),t.drawImage(n.src,0,0,a,s);break;case"left":case"right":var e;1280<s&&(e=a/s,a=Math.floor(1280*e),s=1280),this.setData({canvasWidth:s,canvasHeight:a}),t.drawImage(n.src,0,0,s,a)}t.draw(!1,()=>{wx.canvasToTempFilePath({canvasId:"compressCanvas",fileType:"jpg",success:t=>{const e={orientation:"up",src:t.tempFilePath,width:a,height:s,type:"jpeg"};"left"!==n.orientation&&"right"!==n.orientation||(e.width=s,e.height=a),i(e)},fail(){i(n)}},this)})})},previewImage(t){t=t.currentTarget.dataset.index;const e=this.data.items;if(this.data.preview){const i=[];e.forEach(t=>{i.push(t.src||t.path)}),wx.previewImage({current:e[t].src||e[t].path,urls:i})}this.triggerEvent("preview",{index:t})}}});